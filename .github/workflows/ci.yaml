name: CI

# Controls when the action will run.
on:
  # Triggers the workflow on push or pull request events but only for release branches
  push:
    branches: [main, 1.x]
  pull_request:
    branches: [main, 1.x]
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

concurrency:
  # Cancel previous actions from the same PR or branch except 'main' branch.
  # See https://docs.github.com/en/actions/using-jobs/using-concurrency and https://docs.github.com/en/actions/learn-github-actions/contexts for more info.
  group: concurrency-group::${{ github.workflow }}::${{ github.event.pull_request.number > 0 && format('pr-{0}', github.event.pull_request.number) || github.ref_name }}${{ github.ref_name == 'main' && format('::{0}', github.run_id) || ''}}
  cancel-in-progress: ${{ github.ref_name != 'main' }}

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      all-examples: ${{ steps.set-matrices.outputs.all-examples }}
      bats-tests: ${{ steps.set-bats-tests.outputs.bats-tests }}
    steps:
      - uses: actions/checkout@v5
      - name: Verify BCR patches
        run: patch --dry-run -p1 --fuzz 0 < .bcr/patches/*.patch
      - name: Check for broken links
        uses: lycheeverse/lychee-action@v2
        with:
          # Allow 503 Service Unavailable when rate limited
          args: --accept '200..=204,503' --base ${{ github.workspace }} --verbose --no-progress './**/*.md' './**/*.html'
          fail: false # sigh
      - name: "List all examples"
        id: set-matrices
        run: |
          echo "all-examples=$(find examples -type d -mindepth 1 -maxdepth 1 | sort | jq -R -s -c 'split("\n") | map(select(length > 0))')" >> "$GITHUB_OUTPUT"
      - name: "List folders with bats tests"
        id: set-bats-tests
        run: |
          echo "bats-tests=$(find . -name '*.bats' -path '*/test/*' | sed 's|/test/.*||' | sort -u | jq -R -s -c 'split("\n") | map(select(length > 0))')" >> "$GITHUB_OUTPUT"
          echo "Listed bats folders: $GITHUB_OUTPUT"
  test:
    needs: prepare
    # Our version of clang-format has some deps that aren't satisfiable on newer ubuntu yet
    runs-on: ${{ matrix.folder == 'examples/cpp' && 'ubuntu-22.04' || 'ubuntu-24.04' }}
    strategy:
      fail-fast: false
      matrix:
        folder: ${{ fromJson(needs.prepare.outputs.all-examples) }}
    steps:
      - uses: actions/checkout@v5
      # Permit this gross non-hermetic dependency (for format step on cpp)
      - if: matrix.folder == 'examples/cpp'
        run: sudo apt-get update && sudo apt-get install -y libtinfo5
      - uses: bazel-contrib/setup-bazel@0.18.0
        with: &bazel-setup
          bazelisk-cache: true
          disk-cache: ${{ github.workflow }}
          repository-cache: true
          bazelrc: |
            common     --show_progress_rate_limit=60
            common     --show_timestamps
            build:lint --no@aspect_rules_lint//lint:color
      - name: Check folder capabilities
        id: check
        run: |
          (
            echo "has_format=$([ -d '${{ matrix.folder }}/tools/format' ] && echo true || echo false)"
            echo "has_lint=$([ -d '${{ matrix.folder }}/tools/lint' ] && echo true || echo false)"
            result=$(cd '${{ matrix.folder }}' && bazel query 'tests(...)' 2>/dev/null) || true
            has_tests=$([ -n "$result" ] && echo true || echo false)
            echo "has_tests=$has_tests"
          ) >> "$GITHUB_OUTPUT"
      - if: steps.check.outputs.has_tests == 'true'
        name: Test
        run: bazel test //...
        working-directory: ${{ matrix.folder }}
      - if: steps.check.outputs.has_format == 'true'
        name: Format
        run: bazel run //tools/format
        working-directory: ${{ matrix.folder }}
      - if: steps.check.outputs.has_lint == 'true'
        name: Lint
        working-directory: ${{ matrix.folder }}
        run: |
          bazel build --config=lint --output_groups=rules_lint_human //...
          bazel build --config=lint \
            --output_groups=rules_lint_patch \
            --@aspect_rules_lint//lint:fix \
            //...
  integration-test:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        folder: ${{ fromJson(needs.prepare.outputs.bats-tests) }}
    steps:
      - uses: actions/checkout@v5
      - uses: bazel-contrib/setup-bazel@0.18.0
        with: *bazel-setup
      - name: Install Aspect CLI
        uses: jaxxstorm/action-install-gh-release@v2.1.0
        with:
          repo: aspect-build/aspect-cli
          tag: v2026.4.2
          asset-name: aspect-cli
          rename-to: aspect
          platform: unknown-linux
          arch: x86_64
          chmod: 0755
          extension-matching: disable
      - name: Setup bats
        uses: mig4/setup-bats@v1
        with:
          bats-version: "1.8.2"
      - name: Setup bats helpers
        uses: brokenpip3/setup-bats-libs@0.0.3
        with:
          support-path: /usr/lib/bats/bats-support
          support-version: "0.3.0"
          assert-path: /usr/lib/bats/bats-assert
          assert-version: "2.1.0"
      - name: Integration test
        working-directory: ${{ matrix.folder }}
        run: bats ./test

  test-root:
    strategy:
      matrix:
        # Root module is tested on Linux on Aspect Workflows (Buildkite)
        os:
          - macos-latest
          # TODO(alex): lots of places are missing windows...
          # - windows-latest
        version:
          - 7.x
          - 8.x
          - 9.x
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v5
      - uses: bazel-contrib/setup-bazel@0.8.0
        with:
          repository-cache: ${{ inputs.mount_bazel_caches }}
          bazelrc: |
            common --announce_rc
            common --color=yes
      - name: Test
        env:
          USE_BAZEL_VERSION: ${{ matrix.version }}
        run: bazel test //...
